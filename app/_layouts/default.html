<!DOCTYPE html>
<html>
	{% include head.html %}
	<script src="{{ '/js/search.js' | prepend: site.baseurl }}"  type="text/javascript"></script>
	<script src="{{ '/js/submit.js' | prepend: site.baseurl }}" type="text/javascript"></script>
	<body>
		<div class="pageContainer">
		{% include header.html %}
				{% include edit-nav.html %}
				<div class="pageTitle"> 
					<div>
						{% if page.thumbnail_url %}
							<img class="pageThumb" src="{{ page.thumbnail_url }}"/>
						{% elsif page.uuid %}
							<img class="pageThumb" src="/assets/thumbnails/{{ page.uuid }}.png"/>
						{% endif %}
					</div>
					<div>
						<h1>{{ page.title }}</h1>
					</div>
				</div>
					{% if page.record_superceded_by %}
						{% for dataset in site.datasets %}
							{% if dataset.uuid == page.record_superceded_by %}
								{% assign main_record = dataset %}
							{% endif %}
						{% endfor %}
						<p>
							<b>page superceded by:</b> <a href='{{ main_record.url }}'> {{ main_record.title }}</a>
						</p>
					{% endif %}
				<div class="infoBox">
						<div id="editInfo" >
							{% if page.path contains 'collections' %}
								<a id="editIcon"><img src="/assets/edit.png"></a>
							{% else %}
								<a href="https://docs.google.com/spreadsheets/d/1bdyhGrj0oNz-_qW3Rv2GNGqhZZ73rgj-DYWePLA_1Ms/edit#gid=1389884911"><img src="/assets/edit.png"></a>
							{% endif %}
						</div>
						{% if page.location and page.location != '' %}
						<p>
								<b>location:</b> <a href='{{ page.location }}'>{{ page.location }}</a><br>
						</p>
						{% endif %}
						{% if page.bigquery and page.bigquery != '' %}
							<p>
								This dataset is also queriable online <a href="{{ page.bigquery }}">here</a> via Google BigQuery.
							</p>
						{% endif %}

						{% if page.authors and page.authors.size > 0 %}
							<p>
								<b>authors:</b> {{ page.authors | join: ", " }}
							</p>
						{% endif %}

						{% if page.tags and page.tags.size > 0 %}
							<p>
								<b>tags:</b> {{ page.tags | join: ", " }}
							</p>
						{% endif %}

						{% if page.relationship_description and page.relationship_description != '' %}
							<p>
								<b>relationships to other tools:</b> {{ page.relationship_description }}
							</p>
						{% endif %}

						{% assign RSHIP_TYPES = "parent, child, supercedes, superceded by, similar" | split: ', ' %}

						{% if page.related_projects and page.related_projects.size > 0 %}
							<p>
								<b>related projects:</b>
								<ul>
									{% for relationship_type in RSHIP_TYPES %}
										{% if page.related_projects contains relationship_type %}
										<b>{{ relationship_type }}:</b>
											<ul>
													{% for project in page.related_projects[relationship_type] %}
														<li><a href="{{ site.baseurl }}{{ project }}">{{ project }}</a></li>
													{% endfor %}
											</ul>
											{% endif %}
									{% endfor %}
								</ul>
							</p>
						{% endif %}

					{% if page.path contains 'datasets' %}
						<p><b>add relationship:</b> <span id='toggleAddRship' onclick='toggleAddRship()'>+</span>
						<form id="rship-form">
									<div id="search-container">
										<input type="text" id="rshipSearchInput" placeholder="search..."><br>
										<select name="rship-dataset" id="rshipResultsContainer" class="form-control"></select>
									</span>
								</div>
								<span id="rship-container">
									<select name="rship-type" class="form-control">
										<option>similar</option>
										<option>parent</option>
										<option>child</option>
										<option>supercedes</option>
										<option>superceded by</option>
									</select>
								</span>
								<input type="hidden" id="page-id" name="page-id" value="{{ page.uuid }}|{{page.shortname}}">
								<input type="submit"/>
						</form>
						{% endif %}

						{% assign DISPLAY_FIELDS = "timeframe, terms_of_use, documentation, size, code, related_publications, description, last_edit" | split: ', ' %}

						{% for field in page %}
							{% if DISPLAY_FIELDS contains field %}
								<p id="{{ field }}" data-value="{{ page[field] }}" ><b>{{ field | split: "_" | join: " " }}:</b> {{ page[field] }} </p>
							{% endif %}
						{% endfor %}

				</div>
				<div class="pageContent">
					{{ content }}
				</div>
		</div>


		<script type="text/javascript">

			$.getJSON("/js/search.json", function(json){
				var rship_search = SimpleJekyllSearch({
					searchInput: document.getElementById('rshipSearchInput'),
					resultsContainer: document.getElementById('rshipResultsContainer'),
					templateMiddleware: function(prop, value, template) {
						if (prop === 'url') {
							return value.split(/[\.\/]/)[2]
						}
					},
					json: json,
					searchResultTemplate: '<option value="{category}|{url}">{title}</option>'
				})
			})
			function isURL(str) {
				const pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
					'((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
					'((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
					'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
					'(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
					'(\\#[-a-z\\d_]*)?$','i'); // fragment locator
				return !!pattern.test(str);
			}

			if( isURL($('#documentation').data('value'))) {
				const docURL = $('#documentation').data('value')
				$('#documentation').html(`<b>documentation:</b> <a href='${docURL}'>${docURL}</a>`)
				console.log($('#documentation').data('value'), 'is url!')
			}

			var editUrl = 'https://github.com/Innovation-Information-Initiative/Open-Innovation-Dataset-Index/blob/main' + window.location.pathname.replace(/\..+$/, '') + '.md'
			document.getElementById('editIcon').href = editUrl
		</script>

		<p id="output"></p>
			{% include footer.html %}
	</body>
</html>
