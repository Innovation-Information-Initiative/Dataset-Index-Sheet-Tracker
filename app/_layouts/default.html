<!DOCTYPE html>
<html>
	{% include head.html %}
	<body>
		<div class="pageContainer">
		{% include header.html %}
				{% include edit-nav.html %}
				<div class="pageTitle"> 
					<div>
						{% if page.thumbnail_url %}
							<img class="pageThumb" src="{{ page.thumbnail_url }}"/>
						{% elsif page.uuid %}
							<img class="pageThumb" src="/assets/thumbnails/{{ page.uuid }}.png"/>
						{% endif %}
					</div>
					<div>
						<h1>{{ page.title }}</h1>
					</div>
				</div>
					{% if page.record_superceded_by %}
						{% for dataset in site.datasets %}
							{% if dataset.uuid == page.record_superceded_by %}
								{% assign main_record = dataset %}
							{% endif %}
						{% endfor %}
						<p>
							<b>page superceded by:</b> <a href='{{ main_record.url }}'> {{ main_record.title }}</a>
						</p>
					{% endif %}
				<div class="infoBox">
						<div id="editInfo" >
							{% if page.path contains 'collections' %}
								<a id="editIcon"><img src="/assets/edit.png"></a>
							{% else %}
								<a href="https://docs.google.com/spreadsheets/d/1bdyhGrj0oNz-_qW3Rv2GNGqhZZ73rgj-DYWePLA_1Ms/edit#gid=1389884911"><img src="/assets/edit.png"></a>
							{% endif %}
						</div>
						{% if page.location and page.location != '' %}
						<p>
								<b>location:</b> <a href='{{ page.location }}'>{{ page.location }}</a><br>
						</p>
						{% endif %}
						{% if page.bigquery and page.bigquery != '' %}
							<p>
								This dataset is also queriable online <a href="{{ page.bigquery }}">here</a> via Google BigQuery.
							</p>
						{% endif %}

						{% if page.authors and page.authors.size > 0 %}
							<p>
								<b>authors:</b> {{ page.authors | join: ", " }}
							</p>
						{% endif %}

						{% if page.tags and page.tags.size > 0 %}
							<p>
								<b>tags:</b> {{ page.tags | join: ", " }}
							</p>
						{% endif %}

						{% if page.relationship_description and page.relationship_description != '' %}
							<p>
								<b>relationships to other tools:</b> {{ page.relationship_description }}
							</p>
						{% endif %}

						{% assign RSHIP_TYPES = "parent, child, supercedes, superceded by, similar" | split: ', ' %}

						{% if page.related_projects and page.related_projects.size > 0 %}
							<p>
								<b>related projects:</b>
								<ul>
									{% for relationship_type in RSHIP_TYPES %}
										{% if page.related_projects contains relationship_type %}
										<b>{{ relationship_type }}:</b>
											<ul>
													{% for project in page.related_projects[relationship_type] %}
														<li><a href="{{ site.baseurl }}{{ project }}">{{ project }}</a></li>
													{% endfor %}
											</ul>
											{% endif %}
									{% endfor %}
								</ul>
							</p>
						{% endif %}

						<p><b>add relationship:</b> <span id='toggleAddRship' onclick='toggleAddRship()'>+</span>
						<form id="rship-form">
									<div id="search-container">
										<input type="text" id="rshipSearchInput" placeholder="search..."><br>
										<select name="rship-dataset" id="rshipResultsContainer" class="form-control"></select>
									</span>
								</div>
								<span id="rship-container">
									<select name="rship-type" class="form-control">
										<option>similar</option>
										<option>parent</option>
										<option>child</option>
										<option>supercedes</option>
										<option>superceded by</option>
									</select>
								</span>
								<input type="hidden" id="page-id" name="page-id" value="{{ page.uuid }}|{{page.shortname}}">
								<input type="submit"/>
						</form>

						{% assign DISPLAY_FIELDS = "timeframe, terms_of_use, documentation, size, code, related_publications, description, last_edit" | split: ', ' %}

						{% for field in page %}
							{% if DISPLAY_FIELDS contains field %}
								<p id="{{ field }}" data-value="{{ page[field] }}" ><b>{{ field | split: "_" | join: " " }}:</b> {{ page[field] }} </p>
							{% endif %}
						{% endfor %}

				</div>
				<div class="pageContent">
					{{ content }}
				</div>
		</div>


		<script type="text/javascript">
			console.log( document.getElementById('rshipSearchInput'))
			function isURL(str) {
				const pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
					'((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
					'((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
					'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
					'(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
					'(\\#[-a-z\\d_]*)?$','i'); // fragment locator
				return !!pattern.test(str);
			}

			if( isURL($('#documentation').data('value'))) {
				const docURL = $('#documentation').data('value')
				$('#documentation').html(`<b>documentation:</b> <a href='${docURL}'>${docURL}</a>`)
				console.log($('#documentation').data('value'), 'is url!')
			}

			var editUrl = 'https://github.com/Innovation-Information-Initiative/Open-Innovation-Dataset-Index/blob/main' + window.location.pathname.replace(/\..+$/, '') + '.md'
			document.getElementById('editIcon').href = editUrl
		</script>

<script type="text/javascript">

			function toggleAddRship() {
				const form = document.getElementById("rship-form");

					if (form.style.display === "block") {
						console.log('block')
						form.style.display = "none";
						document.getElementById('toggleAddRship').innerText = '+';
					} else {
						console.log('none')
						form.style.display = "block";
						document.getElementById('toggleAddRship').innerText = '-';
					}
			}

			var rship_search = SimpleJekyllSearch({
				searchInput: document.getElementById('rshipSearchInput'),
				resultsContainer: document.getElementById('rshipResultsContainer'),
				templateMiddleware: function(prop, value, template) {
					if (prop === 'url') {
						return value.split(/[\.\/]/)[2]
					}
				},
				json: '/search.json',
				searchResultTemplate: '<option value="{category}|{url}">{title}</option>'
			})

			window.onload = function() {
				const form = document.getElementById("rship-form");

				const transform = {
					"parent": "child",
					"child": "parent",
					"similar": "similar",
					"supercedes": "superceded by",
					"superceded by": "supercedes"
				}

				form.addEventListener("submit", function(e) {
					e.preventDefault();
					const data = new FormData(form);
					const function_url = "https://iiindex.org/.netlify/functions/webhook_trigger"

					const source_uuid = data.get("page-id").split('|')[0]
					const source_shortname = data.get("page-id").split('|')[1]
					const target_uuid = data.get("rship-dataset").split('|')[0]
					const target_shortname = data.get("rship-dataset").split('|')[1]
					const rship_type = data.get("rship-type")
					const inv_rship_type = transform[rship_type]

					const rship = {
						"uuid": target_uuid,
						"shortname": target_shortname,
						"relationship_type": rship_type
					}


					fetch(function_url, {
						method: "post",
						body: JSON.stringify({
							event_type: 'update_relationship',
							payload: {
								rship: rship,
								uuid: source_uuid
							}
						})
					});

					const inv_rship = {
						'uuid': source_uuid,
						'shortname': source_shortname,
						'relationship_type': inv_rship_type
					}

					fetch(function_url, {
						method: "post",
						body: JSON.stringify({
							event_type: 'update_relationship',
							payload: {
								rship: inv_rship,
								uuid: target_uuid
							}
						})
					});

					console.log(rship, inv_rship)
				})
		}

</script>

<!-- Script pointing to search-script.js -->
<script src="/search.js" type="text/javascript"></script>

		<p id="output"></p>
			{% include footer.html %}
	</body>
</html>
